# 申し送りテンプレート改善 - 文脈保持強化

**作成日**: 2025-10-31
**カテゴリ**: ドキュメント、プロセス改善
**関連**: Note 82 (申し送りとタスクの関係性)

## 背景

### 問題認識

auto compactが実行されると、Claude Codeのセッション文脈が失われ、以下の課題が発生：

1. **文脈の弱化**: 議論の流れや「なぜその決定をしたか」が失われる
2. **継続性の低下**: 次のセッションで同じ議論を繰り返す
3. **暗黙知の消失**: 「空気感」や価値判断の基準が伝わらない

### 検討したアプローチ

#### 案1: PreCompact Hookの活用
- **内容**: Claude CodeのPreCompactフックで自動的に申し送り作成
- **問題点**:
  - フックはcompact直前に発火（手遅れ）
  - ユーザー設定への依存（ロックイン感が強い）
  - 自動化より手動の質が高い
- **結論**: 採用せず

#### 案2: セッション管理ルールの整備
- **内容**: `.claude/`にセッション管理ガイドを配置し、Claude側から定期的に申し送り提案
- **問題点**: ロックイン感が強い
- **結論**: 採用せず

#### 案3: Quick Memo（中間記録）機能
- **内容**: 軽量な中間メモ機能を追加
- **問題点**: 実装が大がかり
- **結論**: 将来的な検討課題

#### 案4: テンプレート改善（採用）
- **内容**: 申し送りテンプレートに文脈保持を強化するセクションを追加
- **利点**:
  - シンプルで即座に実行可能
  - ロックインなし（ユーザー主導）
  - 既存のワークフローに自然に統合
- **結論**: ✅ 採用

## 実装内容

### 追加したセクション

#### 1. Compact前チェックリスト

申し送り作成時に確認すべき項目：

```markdown
## 🔔 Compact前チェックリスト

### トークン使用量の目安
トークン予算の**75-85%**を超えたら申し送り作成を検討しましょう。

- **75%超**: 余裕を持って検討開始
- **85%超**: 早急に申し送り作成
- **100%**: auto compactが発火（文脈が失われる前に記録を！）

> 💡 **トークン使用量の確認方法**
> 会話中に表示される `Token usage: X/Y; Z remaining` を参照
> 例: Claude Codeの場合は予算200,000トークン

### 記録すべき内容を確認
- [ ] 現在のセッションで決定した重要事項を記録したか？
- [ ] 議論の流れと理由を記録したか？
- [ ] 次のセッションで必要な「文脈」「空気感」を言語化したか？
- [ ] 技術的な決定の「なぜ」を明記したか？
- [ ] 注意事項に新しい学びを追加したか？
```

**設計意図**:
- ユーザーがトークン使用量を意識的に確認
- auto compact前に余裕を持って申し送り作成
- 記録すべき内容の漏れ防止
- 割合ベース（75-85%）で環境非依存

#### 2. セッション文脈サマリー

compactで失われやすい文脈を記録：

```markdown
## セッション文脈サマリー

### 核心的な設計決定
- **決定事項**: [何を決めたか]
  - 理由: [なぜその判断をしたか]
  - 影響範囲: [どこに影響するか]

### 議論の流れ
1. **最初の問題認識**: どんな課題から始まったか
2. **検討したアプローチ**: どんな選択肢を考えたか
3. **最終決定**: 何を選び、なぜそれを選んだか
4. **残った課題**: 何が未解決か

### 次のセッションに引き継ぐべき「空気感」
- **このプロジェクトの優先順位**: 何を最も重視しているか
- **避けるべきアンチパターン**: 過去の失敗から学んだこと
- **重視している価値観**: コードの品質、速度、保守性のバランス
- **現在の開発フェーズ**: プロトタイプ/安定化/最適化など
```

**設計意図**:
- タスクの「何」ではなく判断の「なぜ」を記録
- 議論のプロセスを時系列で記録
- 数値化できない暗黙知を言語化

## 技術的な背景

### Claude Codeのauto compact仕様

- **トークン予算**: 200,000トークン
- **PreCompactフック**: compact直前に発火（`trigger: "auto"` または `"manual"`）
- **制約**: ツールから直接トークン使用量を取得する方法はない
- **システム情報**: `Token usage: X/200000; Y remaining` は会話中に表示される

### トークン使用量の目安設定根拠

- **150,000トークン**: 予算の75%（余裕を持った検討開始ライン）
- **170,000トークン**: 予算の85%（早急な対応が必要なライン）
- **200,000トークン**: 上限（auto compactが発火）

この設定により、auto compact前に十分な余裕を持って申し送りを作成できる。

### 環境非依存の設計

- **割合ベース**: 75-85%で表記（Claude Code、Codex等に対応）
- **将来対応**: トークン予算が増加しても有効
- **ユーザー計算**: 各環境で自分の予算に応じて計算

## AI前提の設計判断

### テンプレート肥大化について

当初「テンプレートが長すぎると使いづらいのでは？」という懸念があったが、以下の理由でフルスペック版を採用：

1. **AIが記入**: 人間の心理的負担を考慮不要
2. **網羅性重視**: チェックリストがあれば漏れなく記録
3. **構造化の利点**: AIにとって明確なガイドになる
4. **実績**: 既存テンプレートが「めっちゃよく機能している」

結論: **70-80行程度のフルスペック版でも問題なし**

## 期待される効果

### 1. 文脈の継続性向上
- セッション間で「なぜその決定をしたか」が失われにくくなる
- 同じ議論を繰り返すコストが削減される

### 2. 暗黙知の明示化
- 「空気感」や価値判断の基準を言語化
- 新しいセッションでも判断の一貫性を保てる

### 3. ユーザー主導の柔軟性
- Hooksに依存せず、ユーザーが自由に運用
- 必要に応じてチェックリストをカスタマイズ可能

## 運用ガイドライン

### 申し送り作成のベストタイミング

1. **長時間セッション**: 1時間以上の作業後
2. **重要な決定後**: アーキテクチャや設計の大きな決定
3. **トークン警告**: 75%超過時
4. **緊急**: 85%超過時（最優先）

### セッション文脈サマリーの書き方

**Good**:
```markdown
### 核心的な設計決定
- **blogAgentにhelp toolを必須化**
  - 理由: バージョン情報と使い方を常に確認可能にするため
  - 影響範囲: 今後作成するすべてのエージェント
```

**Bad** (詳細が足りない):
```markdown
### 核心的な設計決定
- blogAgentを実装した
```

### 「空気感」の記録例

**Good**:
```markdown
### 次のセッションに引き継ぐべき「空気感」
- **優先順位**: 動くプロトタイプ > 完璧な設計（Phase 0では実験重視）
- **避けるアンチパターン**: 業務記録のハードコード（Note 45の教訓）
- **重視する価値観**: 汎用性とメンテナンス性のバランス
- **開発フェーズ**: プロトタイプ段階（大胆な変更OK）
```

## 学んだこと

### 設計判断
1. **シンプルさの価値**: Hooksや自動化より、ユーザー主導のシンプルなアプローチが効果的
2. **ロックイン回避**: 特定の機能への依存を避け、柔軟性を保つ
3. **段階的改善**: 大がかりな機能追加より、既存ツールの改善から始める
4. **AI前提の設計**: 人間の心理的負担を考慮せず、網羅性と構造化を優先

### 文脈保持のポイント
1. **「なぜ」を記録**: 「何をしたか」より「なぜそうしたか」が重要
2. **議論のプロセス**: 結論だけでなく、検討した選択肢と理由を記録
3. **暗黙知の言語化**: 数値化できない判断基準を明示的に記録

## 今後の検討課題

### 短期（必要に応じて）
- [ ] 実際の運用でテンプレートの有効性を検証
- [ ] トークン使用量の目安を実運用に基づいて調整

### 中期（様子を見て判断）
- [ ] Quick Memo機能の必要性を評価
- [ ] セッション管理ルールの軽量版検討

### 長期（Phase 1以降）
- [ ] 申し送り自動生成エージェントの可能性（workMemoAgentの応用）

---

**更新履歴**:
- 2025-10-31: 初版作成（テンプレート改善実施）
