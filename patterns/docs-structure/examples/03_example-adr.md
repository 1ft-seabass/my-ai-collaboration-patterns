# ADR-0005: データベースとして PostgreSQL を採用

**Status**: Accepted
**Date**: 2025-10-15
**Deciders**: 開発チーム全員
**Technical Story**: [Issue #123] データベース選定

---

## 背景

新規プロジェクトのデータベースを選定する必要がある。

### 要件

- **データモデル**: リレーショナル（ユーザー、投稿、コメント等の関連性が強い）
- **トランザクション**: ACID 保証が必要（決済機能あり）
- **スケーラビリティ**: 初期は小規模だが、将来的に数十万ユーザー想定
- **予算**: 初期は低コスト、必要に応じてスケールアップ可能
- **開発体制**: チーム内に PostgreSQL 経験者が3名、MySQL 経験者が2名

### 検討の経緯

プロジェクトキックオフ時にデータベースの選定が必要となった。当初はMySQLを想定していたが、JSON型の活用や全文検索などの要件が明確になり、再検討することになった。

---

## 選択肢

### 選択肢1: MySQL

**メリット**:
- チームの半数が経験あり（学習コスト低）
- 広く普及しており、情報が豊富
- 軽量で高速（シンプルなクエリの場合）
- レプリケーションが簡単

**デメリット**:
- JSON型のサポートが限定的（PostgreSQLと比較して）
- 全文検索機能が弱い（別途Elasticsearchが必要になる可能性）
- ウィンドウ関数などの高度な機能が少ない
- MVCC（多版並行性制御）がPostgreSQLより劣る

**却下理由**:
- JSON型を活用した柔軟なスキーマ設計が要件として重要
- 全文検索機能が必要（将来的に投稿検索機能を実装）

---

### 選択肢2: PostgreSQL（採用）

**メリット**:
- JSON/JSONB型が強力（柔軟なスキーマ設計が可能）
- 全文検索機能が組み込み（pg_trgm, ts_vector）
- 高度なSQL機能（ウィンドウ関数、CTE、配列型など）
- MVCC が優秀（読み取りと書き込みがブロックしない）
- 拡張性が高い（PostGIS, pgvectorなど）
- ライセンスがリベラル（PostgreSQL License）

**デメリット**:
- MySQLより若干重い（リソース消費が多い）
- レプリケーション設定がやや複雑

**採用理由**:
- JSON型の活用が要件として重要
- 全文検索を追加サービスなしで実現できる
- チーム内に経験者が多い（3名）
- 将来的な拡張性（PostGISでの位置情報、pgvectorでのベクトル検索など）

---

### 選択肢3: MongoDB

**メリット**:
- スキーマレスで柔軟
- JSON（BSON）ネイティブ
- 水平スケーリングが容易
- 開発速度が速い

**デメリット**:
- リレーショナルな構造が弱い（JOINがない）
- トランザクションのサポートが限定的（v4.0以降で改善されたが）
- ACID保証が弱い（決済機能には不向き）
- チーム内に経験者がいない（学習コスト高）

**却下理由**:
- データモデルが明らかにリレーショナル
- ACID保証が必須（決済機能あり）
- チーム内の経験不足

---

### 選択肢4: SQLite

**メリット**:
- セットアップ不要（ファイルベース）
- 軽量で高速
- デプロイが簡単

**デメリット**:
- 同時書き込みに弱い（ファイルロック）
- スケーラビリティに限界
- 複数サーバーでの運用が困難

**却下理由**:
- 将来的なスケーラビリティが不足
- 複数サーバー構成を想定している

---

## 決定

**PostgreSQL を採用する**

### 詳細

- **バージョン**: PostgreSQL 16（最新安定版）
- **ホスティング**: 初期は AWS RDS（マネージドサービス）
- **接続**: Prisma ORM を使用（型安全性とマイグレーション管理）
- **バックアップ**: RDS自動バックアップ + 手動スナップショット

---

## 理由

### 1. 要件との適合性

| 要件 | MySQL | PostgreSQL | MongoDB | SQLite |
|------|-------|------------|---------|--------|
| ACID保証 | ✅ | ✅ | △ | ✅ |
| リレーショナル | ✅ | ✅ | ❌ | ✅ |
| JSON型 | △ | ✅ | ✅ | △ |
| 全文検索 | △ | ✅ | ✅ | △ |
| スケーラビリティ | ✅ | ✅ | ✅ | ❌ |
| チーム経験 | △ | ✅ | ❌ | △ |

PostgreSQL が最も要件を満たしている。

### 2. チームの経験

- PostgreSQL 経験者: 3名（60%）
- オンボーディングコストが低い
- トラブル時の対応が可能

### 3. 将来性

- **全文検索**: 投稿検索機能で使用予定
- **PostGIS**: 位置情報機能の拡張可能性
- **pgvector**: AI機能（埋め込み検索）の将来的な追加

### 4. コスト

- AWS RDS での運用コスト: MySQL と PostgreSQL はほぼ同等
- 追加サービス（Elasticsearch等）が不要

---

## トレードオフ

### 良い影響（Pros）

✅ **強力なJSON型**
- 柔軟なスキーマ設計が可能
- スキーマ変更が少ない部分で有効

✅ **組み込み全文検索**
- Elasticsearch等の追加サービスが不要
- インフラがシンプルに

✅ **高度なSQL機能**
- 複雑な集計クエリが書きやすい
- パフォーマンス最適化の選択肢が多い

✅ **将来の拡張性**
- PostGIS, pgvector等の拡張が利用可能

### 悪い影響（Cons）

⚠️ **リソース消費がやや多い**
- 小規模環境では MySQL より重い
- → RDS の適切なインスタンスサイズで対応（t3.small から開始）

⚠️ **レプリケーション設定が複雑**
- MySQL より手順が多い
- → RDS マネージドサービスで自動化

⚠️ **学習コスト（一部メンバー）**
- MySQL 経験者2名は新規学習が必要
- → ドキュメント整備、ペアプログラミングで対応

---

## 検証方法

以下の方法で決定の妥当性を検証する：

1. **パフォーマンステスト**（1ヶ月後）
   - 想定されるクエリでベンチマーク
   - 目標: 90パーセンタイルで100ms以内

2. **全文検索の実装**（2ヶ月後）
   - pg_trgm での検索精度・速度を検証
   - Elasticsearch 不要を確認

3. **開発生産性の評価**（3ヶ月後）
   - チームメンバーへのアンケート
   - スキーマ変更の頻度・容易さを評価

---

## 関連リソース

### ドキュメント

- [PostgreSQL 16 公式ドキュメント](https://www.postgresql.org/docs/16/)
- [Prisma + PostgreSQL ガイド](https://www.prisma.io/docs/concepts/database-connectors/postgresql)
- 社内: `docs/development/best-practices/database/`

### 設定ファイル

- `prisma/schema.prisma` - データベーススキーマ
- `.env.example` - 接続設定の例
- `infrastructure/database/` - RDS設定（Terraform）

### 関連 ADR

- [ADR-0004: Prisma ORM の採用](./0004-prisma-orm.md)
- [ADR-0006: AWS RDS の選定](./0006-aws-rds.md)（作成予定）

---

## 補足

### もし失敗したら？

以下の条件が揃った場合、MySQL への移行を検討する：

- パフォーマンスが要件を満たさない（3ヶ月後評価）
- リソースコストが予算を大幅に超過（月次評価）
- チームの学習コストが予想以上に高い（1ヶ月後評価）

ただし、Prisma ORM を使用しているため、移行コストは比較的低い。

### 参考情報

- [Uber が PostgreSQL から MySQL に移行した理由（2016）](https://eng.uber.com/postgres-to-mysql-migration/)
  - 注: 当時と現在では PostgreSQL の性能が大幅に改善
- [PostgreSQL vs MySQL: 2025年版比較](https://example.com/postgresql-vs-mysql-2025)

---

**承認者**: @tech-lead, @architect, @team
**実装開始**: 2025-10-16
**次回レビュー**: 2026-01-15（3ヶ月後）
